### 大型网站架构
### 一. 大型网站架构演化
#### 1.1 大型网站架构特点
1. 高并发、大流量
2. 高可用
3. 海量数据：需要存储、管理海量数据，需要使用大量服务器。
4. 用户分布广泛，网络情况复杂
5. 安全环境恶劣：由于互联网开放性，使得网站容易受到攻击。
6. 需求快速变更，发布频繁
7. 渐进式发展

#### 1.2 大型网站架构演化过程
1. **初始阶段的网站架构**： LAMP
2. **应用服务和数据服务分离**：用户越来越多导致存储空间不足，整个网站使用三台服务器，应用服务器、文件服务器和数据库服务器。
3. **使用缓存改善网站性能**：80%的业务访问集中在20%的数据上。可以把这一小部分数据缓存在内存中。缓存分为两种：
   - 本地缓存：速度快，但受服务器内存限制，其缓存数据量有限。
   - 缓存在专门分布式服务器的远程缓存。 
4. **使用应用服务器集群改善网站的并发处理能力**： 使用集群是网站解决高并发、海量数据问题常用的手段。增加服务器分担原来服务器的访问和存储压力。需要使用**负载均衡**来调度集群中的服务器，使服务压力均衡的分配到各个机器。
5. **数据库读写分离**：在网站用户量达到一定规模后，数据库因为负载压力过高而成为网站的瓶颈。 目前大部分主流数据库都提供**主从热备**功能，**通过配置两台数据库主从关系，可以将一台数据库服务器的数据更新同步到另一台服务器上**。写数据时访问主数据库，主数据库通过主从复制机制将数据更新同步到从数据库，**这样当应用读数据的时候，可以通过从数据库获取数据**。
6. **使用反向代理和CDN加速网站响应**：CDN和反向代理基本原理都是**缓存**，一方面加快数据访问速度，另一方面也减轻了后端服务器的负载压力。两者的区别是：
   - CDN部署在网络提供商的机房，使用户在请求网站时，可以从距离自己最近的网络提供商机房获取数据。
   - 反向代理则部署在网站的中心机房，用户访问时首先访问服务器的反向代理，如果反向代理服务器中缓存了用户请求的资源，则直接返回给用户。 
7. **使用分布式文件系统和分布式数据库系统**：采用**业务分库**手段将不同业务的数据库部署在不同的物理服务器上。 可以进行垂直拆分和水平拆分。
8.  **使用NoSQL和搜索引擎**：非关系数据库是对可伸缩的分布式特性具有更好的支持。应用服务器则通过一个统一数据库访问模块访问各种数据，减轻应用程序管理的诸多数据源麻烦。
9. **业务拆分**: 将一个网站拆分成许多不同的应用，每个应用独立部署。应用之间通过一个超链接建立关系。垂直拆分，将不相干的服务拆分出来。
10. **分布式服务**：水平拆分，将多个业务中的公共业务服务提取出来、独立部署。分布式服务通过调用共用业务服务完成具体业务操作。

#### 1.3 大型网站架构演化的价值观
1. 大型网站架构技术的核心价值是随着网站所需灵活应对
2. 驱动大型网站技术发展的主要力量是网站的业务发展


#### 1.4 网站架构的误区
1. 一味追求大公司的解决方案
2. 为了技术而技术
3. 企图用技术解决所有问题

### 二. 大型网站架构模式
**每一个模式描述了一个在我们周围不断重复发生的问题及该问题解决方案的核心。这样，你能一次又一次地使用该方案而不必做重复工作**

#### 2.1 网站架构模式
常用模式有：
 
 - **分层**：将系统在横向维度上切分成几个部分，每个部分负责一部分相对比较单一的职责，然后通过上层对下层的依赖和调用组成一个完整系统。
 - **分割**：按纵向方向对软件进行切分，将不同的功能和服务分割开来，包装成**高内聚低耦合**的模块单元，这些单元或模块可以独立部署
 - **分布式**：将分层和分割后的模块进行分布式部署，即将不同模块部署在不同的服务器上，通过远程调用协调工作
 - **集群**：多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务。
 - **缓存**: 缓存是将数据存放在距离计算最近的位置以加快处理速度、同时减轻后端应用和数据存储的负载压力.


##### 1. 分层
**将系统在横向维度上切分成几个部分，每个部分负责一部分相对比较单一的职责，然后通过上层对下层的依赖和调用组成一个完整系统。**

大型网站将网站系统分为：

- **应用层**：负责具体业务和视图展示，如网站首页及搜索输入和结果展示。
- **服务层**：为应用层提供服务支持，如用户管理服务、购物车服务等。
- **数据库**：提供数据存储访问服务，如数据库、缓存、文件、搜索引擎等。

分层好处：

 - 便于分工合作开发和维护
 - 各层之间有一定的独立性，只要维持调用接口不变，各层可以根据具体问题独立演化发展而不需要其他层必须做出相应调整。
 
挑战：
 
 - 必须合理规划层次边界和接口，在开发中严格遵循分层架构的约束，禁止**跨层次的调用**（应用层直接调用数据库）及**逆向调用**（数据库层调用服务层，或者服务层调用应用层）。

分层结构内部还可以继续分层，如应用层可以分为视图层和业务逻辑层。在物理部署上，三层结构可以部署在同一个物理机器上，但随着业务发展必须对分层的模块**隔离部署**。

##### 2. 分割
分割按纵向方向对软件进行切分，将不同的功能和服务分割开来，包装成**高内聚低耦合**的模块单元，这些单元或模块可以独立部署。存在的好处有：

 - 助于软件的开发和维护
 - 便于不同模块的分布式部署，提高网站并发处理能力和功能扩展能力
 - 可以根据不同模块的特点对不同模块进行优化，提高各模块性能

##### 3. 分布式
对于大型网站来说，分层和分割的一个主要目的是为了切分后的模块便于分布式部署，即将不同模块部署在不同的服务器上，通过远程调用协调工作。

分布式在解决网站高并发问题的同时也带来其他问题：

- 分布式意味着服务调用必须通过**网络**，这样可能对**性能**造成比较严重的影响。
- 服务器越多，服务器的**宕机概率**也就越大。一台机器的宕机造成的服务不可用可能会导致很多应用不可访问，网站**可用性降低**。
- 数据在分布式环境中保持数据一致性也非常困难，**分布式事务**也难以保证，这对网站业务正确性和业务流程有可能造成很大影响。
- 分布式还导致网站依赖错综复杂，**开发管理维护困难**。

分布式方案有几种：

- **分布式应用和服务**: 将分层和分割后的应用和服务模块化分布式部署，除了**改善网站性能和并发性、加快开发和发布速度、减少数据库连接资源消耗**；还可以使用**复用共同的服务**，便于业务功能扩展。
- **分布式静态资源**: 将网站的静态资源如CSS、JS等独立分布式部署，采用独立的域名，即**动静分离**。静态资源分布式部署可以减轻应用服务器的负载压力；通过使用独立域名加快浏览器并发加载的速度。也便于卡法维护，使不同技术工种术业有专攻。
- **分布式数据和存储**
- **分布式计算**: 搜索引擎索引构建、数据仓库等大规模计算普遍使用Hadoop及MapReduce分布式计算框架，特点是移动计算而不是移动数据，将计算程序分发到数据所在的位置及加速计算和分布式计算。

##### 4. 集群
**集群即多台服务器部署相同应用构成一个集群，通过负载均衡设备共同对外提供服务**。一个应用由多台服务器提供，当某台服务器发生故障时，负载均衡设备或系统的失效转移机制会将请求转发到集群中其他服务器上，使服务器故障不影响用户使用。


##### 5. 缓存
缓存是将数据存放在距离计算最近的位置以加快处理速度、同时减轻后端应用和数据存储的负载压力。数据缓存有两个前提：

- 数据访问热点不均衡，某些数据会被频繁的访问。
- 数据在某个时间段内有效，不会很快过期。

一般缓存包含多个方面：

- **CDN**: 即内容分发网络，部署在距离终端用户最近的网络服务商，用户网络请求总是先到达他的网络服务商哪里，这里缓存网站的一些**静态资源**可以以最快速度返回给用户。
- **反向代理**: 反向代理属于网站前端架构的一部分，部署在网站的前端。当用户请求到达网站数据库中心时，最先访问反向代理服务器，这里**缓存网站的静态资源**，如果存在资源则返回给用户无需再请求服务器。
- **本地缓存**: 在应用服务器本地缓存着热点数据。
- **分布式缓存**: 将数据缓存在一个专门的分布式缓存集群中，应用程序通过网络通讯访问缓存数据。

##### 6. 异步
计算机开发的一个重要目标和驱动力是**降低软件耦合性**。  系统解耦的手段除了分层、分割、分布等还有一个重要手段是异步。

**单一服务通过多线程共享内存队列的方式实现异步**。在分布式系统中，多个服务器集群通过分布式消息队列实现异步，分布式消息队列可以看作内存队列的分布式部署（如消息队列kafka）。

异步消息队列有以下特性：

- **提高系统可用性**。消费者如果挂了，数据会在消息队列堆积，生产者服务可以继续处理业务逻辑，系统整体表现无故障。消费者恢复后继续处理消息队列数据。
- **加快网站响应速度**。生产者不用同步等待消费者消费结果，生产者处理完业务请求后将数据写入消息队列就可以返回，响应延迟减少。
- **消除并发访问高峰(削峰)**。使用消息队列将突然增加的访问请求数据写入消息队列中，消费者服务器还是可以继续依次处理，不会对整个网站负载造成太大压力。


##### 7. 冗余
想要保证在服务器宕机的情况下网站依然可以继续服务，不丢失数据，就需要一定程度的服务器冗余运行，数据冗余备份，这样当某台服务器宕机时，可以将其上的服务和数据访问转移到其他机器上。

数据库除了定期备份、存档保存，实现**冷备份**外，为了保证在线业务高可用，还需要对数据库进行主从分离，实现同步**热备份**。

##### 8. 自动化
在无人值守的情况下网站可以正常运行，一切都可以自动化是网站的理想状态。包含：发布过程自动化、自动化代码管理、自动化测试、自动化安全检查、自动化部署、自动化监控、自动化抱紧、自动化失效转移、自动化失效恢复、自动化降级、自动化分配资源。

##### 9. 安全
可以从以下几个方面考虑：密码、手机校验码、通讯加密、敏感信息过滤、风险控制。

### 四. 瞬时响应: 网站的高性能架构
#### 性能指标
1. **响应时间**：指应用执行一个操作需要的时间，包括从发出请求开始到收到最后响应数据所需要的时间。
    - 实践中一般采用平均响应时间，比如重复1万次，求得平均响应时间。 
2. **并发数**: 系统能够同时处理请求的数据，也反映了系统的负载特性。
    - 通过多线程模拟并发用户来测试系统的并发处理能力，两次请求之间加入一个随机等待时间。
3. **吞吐量**: 指单位时间内系统处理的请求数量，提现系统的整体处理能力。如：“请求数/秒”、“页面数/秒”。
    - **TPS**: 每秒事务数
    - **HPS**: 每秒HTTP请求数
    - **QPS**: 每秒查询数
4. **性能测试器**: 描述服务器或操作系统性能的一些数据指标，包括System Load、对象与线程数、内存使用、CPU使用、磁盘和网络I/O等指标。
  - System load即系统负载：当前正在被CPU执行和等待CPU执行的进程数据之和，反映系统忙闲程度的重要指标。可通过top命令查看。

#### 性能测试方法
1. **性能测试**

  


